# Cal.com Integration - Safe Webhook + Embed Widget

## üéØ –¶–µ–ª—å
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é Cal.com –≤–µ–±—Ö—É–∫–æ–≤ –∏ embed –≤–∏–¥–∂–µ—Ç–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ç–æ—á–µ—á–Ω—ã–º–∏ –ø—Ä–∞–≤–∫–∞–º–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### üîê –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–µ–±—Ö—É–∫ —ç–Ω–¥–ø–æ–π–Ω—Ç
- **–ü—É—Ç—å:** `/api/cal/webhook` (Astro endpoint)
- **Runtime:** Node.js
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** 
  - RAW body —á—Ç–µ–Ω–∏–µ –¥–æ JSON.parse
  - HMAC-SHA256 –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å `crypto.timingSafeEqual`
  - Case-insensitive –∑–∞–≥–æ–ª–æ–≤–æ–∫ `x-cal-signature-256`
  - Timing-safe —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** Fire-and-forget –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ (dev: console.info, prod: –∑–∞–≥–ª—É—à–∫–∞)

### üìÖ Cal.com Embed –≤–∏–¥–∂–µ—Ç
- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `apps/website/src/widgets/cal/CalEmbed.astro`
- **–§—É–Ω–∫—Ü–∏–∏:**
  - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Cal.com —Å–∫—Ä–∏–ø—Ç–∞
  - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
  - –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è (EN/RU)
  - Fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –ß–∏—Ç–∞–µ—Ç `CAL_EMBED_LINK` –∏–∑ env

### üåê –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- **EN:** `/en/bookme` - "Book a Meeting"
- **RU:** `/ru/bookme` - "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –≤—Å—Ç—Ä–µ—á—É"
- **–ù–∞–≤–∏–≥–∞—Ü–∏—è:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Å—ã–ª–∫–∏ –≤ navbar —Ä–∞–±–æ—Ç–∞—é—Ç

### ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- **Astro:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `TUNNEL_HOSTS` –∏–∑ env –¥–ª—è —Ç—É–Ω–Ω–µ–ª–µ–π
- **Env:** –î–æ–±–∞–≤–ª–µ–Ω—ã `CAL_WEBHOOK_SECRET`, `CAL_EMBED_LINK`, `TUNNEL_HOSTS`
- **Package.json:** –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ–±—Ö—É–∫–∞–º–∏

### üõ†Ô∏è –£—Ç–∏–ª–∏—Ç—ã
- **–°–∫—Ä–∏–ø—Ç:** `scripts/cal-webhook.mjs` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ–±—Ö—É–∫–æ–≤
- **–ö–æ–º–∞–Ω–¥—ã:** `npm run cal:webhook:create|update|list`
- **–¢–µ—Å—Ç—ã:** Unit-—Ç–µ—Å—Ç—ã –¥–ª—è `verifySignature` —Ñ—É–Ω–∫—Ü–∏–∏

## üîß –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### 1. –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
```bash
cd apps/website
cp env.example .env.local
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env.local —Å –≤–∞—à–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
npm run dev
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
- http://localhost:4321/en/bookme
- http://localhost:4321/ru/bookme

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ–±—Ö—É–∫–∞
```bash
# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç—É–Ω–Ω–µ–ª—å (ngrok)
export PUBLIC_URL="https://your-ngrok-url.ngrok-free.app"
npm run cal:webhook:create
```

### 4. Unit-—Ç–µ—Å—Ç—ã
```bash
npm test src/server/cal/verify.test.ts
```

## üìã Checklist

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- [x] –°—Ç—Ä–∞–Ω–∏—Ü—ã bookme –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è
- [x] Cal.com –≤–∏–¥–∂–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
- [x] –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
- [x] –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –í–µ–±—Ö—É–∫ —ç–Ω–¥–ø–æ–π–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [x] –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ù–µ–≤–µ—Ä–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏ –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è (401)
- [x] RAW body —á–∏—Ç–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] Timing-safe —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
- [x] –°–µ–∫—Ä–µ—Ç—ã –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- [x] –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –≤–µ–±—Ö—É–∫–∞ (204/200)
- [x] –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- [x] –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Cal.com
- [x] –ù–µ—Ç –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üöÄ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—É–Ω–Ω–µ–ª–µ–π
- ‚úÖ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ç–µ–º—ã
- ‚úÖ Unit-—Ç–µ—Å—Ç—ã
- ‚úÖ –£—Ç–∏–ª–∏—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: `CAL_INTEGRATION_README.md`
