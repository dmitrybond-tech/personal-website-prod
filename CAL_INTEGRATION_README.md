# Cal.com Integration - Инструкция по проверке

## Обзор изменений

Была реализована безопасная интеграция Cal.com вебхуков и embed виджета с минимальными точечными правками в существующую архитектуру.

## Что было изменено

### 1. API Эндпойнт вебхука (`/api/cal/webhook`)
- ✅ Безопасная верификация подписи с `crypto.timingSafeEqual`
- ✅ Чтение RAW body до JSON.parse
- ✅ Case-insensitive заголовок `x-cal-signature-256`
- ✅ Асинхронная обработка (fire-and-forget)
- ✅ Структурированное логирование
- ✅ Обработка основных триггеров: `BOOKING_CREATED`, `BOOKING_RESCHEDULED`, `BOOKING_CANCELLED`

### 2. Компонент CalEmbed
- ✅ Новый виджет `apps/website/src/widgets/cal/CalEmbed.astro`
- ✅ Асинхронная загрузка Cal.com embed скрипта
- ✅ Поддержка темной темы
- ✅ Локализация (EN/RU)
- ✅ Fallback при ошибке загрузки

### 3. Страницы bookme
- ✅ Обновлены `/en/bookme` и `/ru/bookme`
- ✅ Используют новый компонент CalEmbed
- ✅ Сохранена существующая навигация

### 4. Конфигурации
- ✅ `astro.config.mjs` - поддержка `TUNNEL_HOSTS` из env
- ✅ `env.example` - добавлены переменные Cal.com
- ✅ `package.json` - скрипты управления вебхуками

### 5. Утилиты
- ✅ `scripts/cal-webhook.mjs` - управление вебхуками Cal.com
- ✅ `verify.test.ts` - unit-тесты для верификации подписи

## Как проверить локально

### 1. Настройка окружения

```bash
# Скопируйте env.example в .env.local
cp apps/website/env.example apps/website/.env.local

# Отредактируйте .env.local с вашими значениями:
# CAL_WEBHOOK_SECRET=your_actual_secret
# CAL_EMBED_LINK=https://cal.com/your-username/your-event-type
# TUNNEL_HOSTS=*.lhr.life,*.ngrok-free.app
```

### 2. Запуск в dev режиме

```bash
cd apps/website
npm run dev
```

### 3. Проверка страниц bookme

Откройте в браузере:
- http://localhost:4321/en/bookme
- http://localhost:4321/ru/bookme

**Ожидаемый результат:**
- ✅ Страницы загружаются без ошибок
- ✅ Отображается заголовок и описание на соответствующем языке
- ✅ Cal.com виджет загружается асинхронно
- ✅ Поддерживается темная тема
- ✅ Навигация работает корректно

### 4. Проверка вебхука через туннель

#### 4.1. Настройка туннеля (например, ngrok)

```bash
# Установите ngrok если не установлен
npm install -g ngrok

# Запустите туннель
ngrok http 4321
```

#### 4.2. Создание вебхука в Cal.com

```bash
# Установите переменные окружения
export CAL_CLIENT_ID="your_cal_client_id"
export CAL_CLIENT_SECRET="your_cal_client_secret"
export PUBLIC_URL="https://your-ngrok-url.ngrok-free.app"

# Создайте вебхук
npm run cal:webhook:create
```

#### 4.3. Тестирование вебхука

```bash
# Проверьте, что вебхук создан
npm run cal:webhook:list

# Сделайте тестовый запрос
curl -X POST https://your-ngrok-url.ngrok-free.app/api/cal/webhook \
  -H "Content-Type: application/json" \
  -H "x-cal-signature-256: your_test_signature" \
  -d '{"triggerEvent":"BOOKING_CREATED","payload":{"type":"test"}}'
```

**Ожидаемый результат:**
- ✅ Вебхук создается успешно
- ✅ Тестовый запрос возвращает 401 (неверная подпись) - это нормально
- ✅ В логах dev сервера видны попытки верификации

### 5. Проверка unit-тестов

```bash
# Если у вас настроен Vitest
npm test src/server/cal/verify.test.ts
```

**Ожидаемый результат:**
- ✅ Все тесты проходят
- ✅ Проверяется timing-safe сравнение
- ✅ Проверяются edge cases

## Checklist для проверки

### Функциональность
- [ ] Страницы `/en/bookme` и `/ru/bookme` загружаются
- [ ] Cal.com виджет отображается корректно
- [ ] Локализация работает (EN/RU)
- [ ] Темная тема поддерживается
- [ ] Навигация в navbar работает
- [ ] Вебхук эндпойнт отвечает на GET запросы
- [ ] Вебхук эндпойнт корректно обрабатывает POST запросы

### Безопасность
- [ ] Верификация подписи работает корректно
- [ ] Неверные подписи отклоняются (401)
- [ ] RAW body читается до JSON.parse
- [ ] Timing-safe сравнение используется
- [ ] Секреты не логируются

### Производительность
- [ ] Вебхук быстро отвечает (204/200)
- [ ] Обработка событий асинхронная
- [ ] Cal.com скрипт загружается асинхронно
- [ ] Нет блокирующих операций

### Конфигурация
- [ ] `TUNNEL_HOSTS` поддерживается в dev
- [ ] Переменные окружения читаются корректно
- [ ] Скрипты управления вебхуками работают
- [ ] Unit-тесты проходят

## Возможные проблемы и решения

### 1. Cal.com виджет не загружается
**Причина:** Неверная ссылка в `CAL_EMBED_LINK`
**Решение:** Проверьте и обновите ссылку в `.env.local`

### 2. Вебхук возвращает 401
**Причина:** Неверная подпись или секрет
**Решение:** Проверьте `CAL_WEBHOOK_SECRET` в Cal.com настройках

### 3. Туннель не работает
**Причина:** `TUNNEL_HOSTS` не настроен
**Решение:** Добавьте ваш туннельный домен в `TUNNEL_HOSTS`

### 4. Скрипт вебхука не работает
**Причина:** Отсутствуют переменные окружения
**Решение:** Установите `CAL_CLIENT_ID`, `CAL_CLIENT_SECRET`, `PUBLIC_URL`

## Дополнительные возможности

### Интеграции (TODO)
В коде есть заготовки для интеграций:
- Telegram уведомления
- Notion записи
- Email follow-up
- Аналитика

### Мониторинг
Рекомендуется добавить:
- Логирование в файл/базу
- Метрики производительности
- Алерты на ошибки

## Заключение

Интеграция реализована согласно всем требованиям:
- ✅ Безопасная верификация подписи
- ✅ Минимальные изменения в существующем коде
- ✅ Поддержка туннелей для разработки
- ✅ Локализация и темы
- ✅ Unit-тесты
- ✅ Утилиты управления

Все компоненты готовы к использованию в продакшене.
