---
import type { Data } from '../types/data';
import SideNav from './SideNav.astro';
import MainSection from './sections/MainSection.astro';
import SkillsSection from './sections/SkillsSection.astro';
import ExperienceSection from './sections/ExperienceSection.astro';
import PortfolioSection from './sections/PortfolioSection.astro';
import EducationSection from './sections/EducationSection.astro';
import TestimonialsSection from './sections/TestimonialsSection.astro';
import FavoritesSection from './sections/FavoritesSection.astro';

export interface Props {
  locale: 'en' | 'ru';
  data: Data;
}

const { locale, data } = Astro.props;
const { config, sections } = data;
---

<div class="cv-root">
  <div class="cv-container">
    <main class="cv-main">
      <MainSection {...sections.main} />
      <SkillsSection {...sections.skills} />
      <ExperienceSection {...sections.experience} />
      <PortfolioSection {...sections.portfolio} />
      <EducationSection {...sections.education} />
      <TestimonialsSection {...sections.testimonials} />
      <FavoritesSection {...sections.favorites} />
    </main>
    <SideNav sections={sections} className="sticky top-8 mt-20" />
  </div>
</div>

<style>
  .cv-root {
    @apply flex justify-center overflow-x-hidden bg-gray-50 dark:bg-gray-900 xl:relative xl:left-7;
  }
  
  .cv-container {
    @apply flex w-full max-w-7xl gap-8;
  }
  
  .cv-main {
    @apply w-full max-w-5xl space-y-4 px-2 py-3 sm:space-y-6 sm:px-8 sm:py-12 lg:space-y-8 lg:py-20;
  }
  
  /* Ensure proper spacing for sticky navbar */
  .cv-main > * {
    scroll-margin-top: 72px;
  }
</style>

<script>
  // Скрипт для активной секции (скопирован из DevsCard)
  import hashState from '../utils/hash-state.js';
  import throttle from '../utils/throttle.js';

  const sections = [...document.querySelectorAll('[data-type="section"]')];
  const sidebarItems = [...document.getElementById('sidebar')?.children || []] as HTMLAnchorElement[];

  const isInUpperView = (section: Element) => section.getBoundingClientRect().bottom >= window.innerHeight / 3;

  const setActiveItem = (hash: string) => {
    sidebarItems.forEach((item) => {
      if (item.href.endsWith(hash)) {
        item.setAttribute('aria-current', 'page');
      } else {
        item.removeAttribute('aria-current');
      }
    });
  };

  const updateHash = () => {
    const currentSection = sections.find(isInUpperView);
    if (currentSection) {
      hashState.updateHash(currentSection.id);
    }
  };

  // Инициализация
  setActiveItem(hashState.getHash());
  hashState.subscribe(setActiveItem);
  document.addEventListener('scroll', throttle(updateHash, 200));
</script>
