---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navbar from '@app/widgets/navbar/ui/Navbar.astro';
import BookingTiles from '@app/components/bookme/BookingTiles.astro';
import { CAL_EVENT_TYPES } from '@app/data/cal/event-types';
import bookmeClientUrl from '@shared/cal/page-bookme.ts?url';

const locale = 'en';
const pageTitle = 'Book a meeting';
const DEFAULT_CAL_LINK = CAL_EVENT_TYPES[0]?.calLink || 'dmitrybond/intro-30m';
---

<BaseLayout title={pageTitle}>
  <Navbar locale={locale} />
  
  <section class="mx-auto max-w-[var(--cv-max-w)] px-[var(--cv-gap)] py-8">
    <h1 class="mb-4 text-2xl font-bold">{pageTitle}</h1>
    <BookingTiles locale={locale} events={CAL_EVENT_TYPES} />
  </section>

  <section id="cal-section" class="mx-auto max-w-[var(--cv-max-w)] px-[var(--cv-gap)] py-6 relative isolate">
    <div id="cal-inline" class="cal-inline-wrapper min-h-[640px]"></div>
  </section>

  <!-- 1) Официальный Cal bootstrap (НЕ менять порядок) -->
  <script is:inline>
    (function (C, A, L) {
      let p = function (a, ar) { a.q.push(ar); };
      let d = C.document;
      C.Cal = C.Cal || function () {
        let cal = C.Cal, ar = arguments;
        if (!cal.loaded) {
          cal.ns = {}; cal.q = cal.q || [];
          d.head.appendChild(d.createElement("script")).src = A;
          cal.loaded = true;
        }
        if (ar[0] === L) {
          const api = function () { p(api, arguments); };
          const ns = ar[1]; api.q = api.q || [];
          typeof ns === "string" ? (cal.ns[ns] = api) && p(api, ar) : p(cal, ar);
          return;
        }
        p(cal, ar);
      };
    })(window, "https://app.cal.com/embed/embed.js", "init");
  </script>

  <!-- 2) Глобальная конфигурация -->
  <script is:inline>
    Cal.config = Cal.config || {};
    Cal.config.forwardQueryParams = true;
  </script>

  <!-- 3) Инициализация с синхронизацией темы -->
  <script type="module" src={bookmeClientUrl}></script>
</BaseLayout>