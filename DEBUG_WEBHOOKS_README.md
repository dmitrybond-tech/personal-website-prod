# Debugging Cal Webhooks

## üîç –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

–í–µ–±—Ö—É–∫ Cal.com —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É–¥–æ–±–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏. –í—Å–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º JSON —Ñ–æ—Ä–º–∞—Ç–µ.

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

```bash
# –í .env.local
CAL_DEBUG=1                    # –í–∫–ª—é—á–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
CAL_DUMP_WEBHOOKS_DIR=var/webhooks  # –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```

### –õ–æ–≥–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è

–ü—Ä–∏ `CAL_DEBUG=1` –≤–µ–±—Ö—É–∫ –ª–æ–≥–∏—Ä—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è:

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (`cal.webhook.check`):**
- `requestId` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø—Ä–æ—Å–∞ (UUID)
- `method` - HTTP –º–µ—Ç–æ–¥ (POST)
- `url` - –ø—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞
- `ip` - IP –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞ (–∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ x-forwarded-for, cf-connecting-ip)
- `ua` - User-Agent
- `ct` - Content-Type
- `bodyLen` - —Ä–∞–∑–º–µ—Ä —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ –±–∞–π—Ç–∞—Ö
- `bodySha` - SHA256 —Ö—ç—à —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
- `hasSigHeader` - –Ω–∞–ª–∏—á–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–æ–¥–ø–∏—Å–∏
- `sigHeaderLen` - –¥–ª–∏–Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ø–æ–¥–ø–∏—Å–∏
- `localSigLen` - –¥–ª–∏–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å–∏
- `sigEqual` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–µ–π
- `timestamp` - –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `processingTimeMs` - –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö

**–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–±—ã—Ç–∏–∏ (`cal.webhook.success`):**
- `requestId` - ID –∑–∞–ø—Ä–æ—Å–∞
- `event` - –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è
- `triggerEvent` - —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è (BOOKING_CREATED, BOOKING_RESCHEDULED, etc.)
- `bookingId` - ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `timestamp` - –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `processingTimeMs` - –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è (`cal.webhook.process`):**
- `requestId` - ID –∑–∞–ø—Ä–æ—Å–∞
- `triggerEvent` - —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
- `bookingId` - ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `payload` - –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
- `fullEvent` - –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º `CAL_DEBUG=1` –∏ —É–∫–∞–∑–∞–Ω–Ω–æ–π `CAL_DUMP_WEBHOOKS_DIR`:
- –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- –ö–∞–∂–¥—ã–π –≤–µ–±—Ö—É–∫ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ñ–∞–π–ª: `{timestamp}-{requestId}.json`
- –§–∞–π–ª—ã —Å–æ–¥–µ—Ä–∂–∞—Ç —Å—ã—Ä–æ–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

### –ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤

–í—Å–µ –æ—Ç–≤–µ—Ç—ã –≤–µ–±—Ö—É–∫–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `x-debug-id` —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º ID –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏.

### –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

```json
{
  "level": "info",
  "msg": "cal.webhook.check",
  "requestId": "123e4567-e89b-12d3-a456-426614174000",
  "method": "POST",
  "url": "/api/cal/webhook",
  "ip": "192.168.1.1",
  "ua": "Cal.com-Webhook/1.0",
  "ct": "application/json",
  "bodyLen": 1024,
  "bodySha": "a1b2c3d4e5f6...",
  "hasSigHeader": true,
  "sigHeaderLen": 64,
  "localSigLen": 64,
  "sigEqual": true,
  "timestamp": "2024-01-15T10:30:00.000Z",
  "processingTimeMs": 45
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–û—à–∏–±–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
- `server-misconfigured: missing CAL_WEBHOOK_SECRET` (500)
- `missing-signature` (401)
- `invalid-signature` (401) - —Å –ø–µ—Ä–≤—ã–º–∏ 8 —Å–∏–º–≤–æ–ª–∞–º–∏ –ø–æ–¥–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–û—à–∏–±–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
- `Invalid JSON` (400) - –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON

–í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å `requestId` –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏.

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

1. **–í–∫–ª—é—á–∏—Ç–µ –æ—Ç–ª–∞–¥–∫—É:**
   ```bash
   CAL_DEBUG=1
   CAL_DUMP_WEBHOOKS_DIR=var/webhooks
   ```

2. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –≤–µ–±—Ö—É–∫** –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

3. **–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã** –≤ –ø–∞–ø–∫–µ `var/webhooks/`

4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `requestId`** –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `x-debug-id` –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –ª–æ–≥–∞—Ö

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í DEBUG —Ä–µ–∂–∏–º–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 8 —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ–¥–ø–∏—Å–µ–π
- –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç–∫–ª—é—á–∏—Ç—å `CAL_DEBUG=0`
