name: Deploy Preprod

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64, preprod]
    permissions:
      contents: read
      packages: write

    env:
      IMAGE_MAIN: ghcr.io/${{ toLower(github.repository) }}:main
      IMAGE_SHA:  ghcr.io/${{ toLower(github.repository) }}:sha-${{ github.sha }}

    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
          logout: false   # <-- держим логин на self-hosted

      - name: Pull image (sha or main)
        shell: bash
        run: |
          set -euo pipefail
          docker pull "$IMAGE_SHA" || docker pull "$IMAGE_MAIN"

      - name: Restart container
        shell: bash
        run: |
          set -euo pipefail
          docker rm -f website-preprod || true
          docker run -d --name website-preprod \
            -p 127.0.0.1:3000:3000 \
            -e NODE_ENV=production \
            "$IMAGE_SHA" || docker run -d --name website-preprod \
            -p 127.0.0.1:3000:3000 \
            -e NODE_ENV=production \
            "$IMAGE_MAIN"

      - name: Show running containers
        run: docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}'
