# Docker Build Fix - Final Implementation

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞

**–ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** Preprod –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–ª placeholder'—ã –≤–º–µ—Å—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –ø–æ—Ç–æ–º—É —á—Ç–æ `dist/client/uploads` –Ω–µ –ø–æ–ø–∞–¥–∞–ª –≤ runtime –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.

## üîß –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. **–û–±–Ω–æ–≤–ª–µ–Ω Dockerfile** (`apps/website/Dockerfile`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `git` –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã npm
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —É–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è `npm ci`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ `npm install` –µ—Å–ª–∏ `npm ci` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è debugging
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω fallback –¥–ª—è workspace build –Ω–∞ –ø—Ä—è–º–æ–π build
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ build args –¥–ª—è PUBLIC_* –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### 2. **–û–±–Ω–æ–≤–ª–µ–Ω package.json** (–∫–æ—Ä–Ω–µ–≤–æ–π)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `workspaces: ["apps/website"]`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å–∫—Ä–∏–ø—Ç `build:website`
- ‚úÖ –°–æ–∑–¥–∞–Ω `package-lock.json` –≤ –∫–æ—Ä–Ω–µ

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω compose.prod.yml**
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω dockerfile –ø—É—Ç—å –Ω–∞ `apps/website/Dockerfile`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—Ç —Å 80 –Ω–∞ 3000
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è traefik

### 4. **–°–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã**
- ‚úÖ `test-docker-build-vps.sh` - –¥–ª—è Linux VPS
- ‚úÖ `test-docker-build-vps.ps1` - –¥–ª—è Windows

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ VPS

### **1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º:**
```bash
# –ù–∞ VPS –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
chmod +x test-docker-build-vps.sh
./test-docker-build-vps.sh
```

### **2. –î–µ–ø–ª–æ–π:**
```bash
# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–µ–ø–ª–æ–π:
docker-compose -f compose.prod.yml up -d --build
```

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–¥–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
curl -I http://localhost:3000/uploads/placeholders/avatar.png
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: Content-Type: image/png
```

## üîç –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Å–±–æ—Ä–∫–µ

### **Build Stage:**
1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç git –∏ –¥—Ä—É–≥–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
2. –ö–æ–ø–∏—Ä—É–µ—Ç package.json —Ñ–∞–π–ª—ã
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å fallback
5. –ö–æ–ø–∏—Ä—É–µ—Ç –≤–µ—Å—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
6. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É workspace
7. –°–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç —Å fallback –Ω–∞ –ø—Ä—è–º–æ–π build
8. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ uploads —Å—É—â–µ—Å—Ç–≤—É–µ—Ç** (guard)
9. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É dist –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

### **Runtime Stage:**
1. –ö–æ–ø–∏—Ä—É–µ—Ç –≤–µ—Å—å `dist` (server + client + uploads)
2. –ó–∞–ø—É—Å–∫–∞–µ—Ç Node.js —Å–µ—Ä–≤–µ—Ä

## üõ°Ô∏è –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∑–∞—â–∏—Ç—ã

### **Guard Check:**
```dockerfile
RUN test -d /app/apps/website/dist/client/uploads
```
**–ï—Å–ª–∏ uploads –Ω–µ—Ç ‚Üí –±–∏–ª–¥ –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π**

### **Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã:**
- `npm ci` ‚Üí `npm install` –µ—Å–ª–∏ –ø–µ—Ä–≤—ã–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- `npm run --workspace` ‚Üí `cd apps/website && npm run build`

### **Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:**
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ package.json —Ñ–∞–π–ª–æ–≤
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ dist –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏

## üìã –õ–æ–≥–∏ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–µ

```
=== ROOT PACKAGE.JSON ===
{"name":"personal-website-monorepo","workspaces":["apps/website"],...}

=== WEBSITE PACKAGE.JSON ===
{"name":"website","scripts":{"build":"astro build"},...}

=== WORKSPACE STRUCTURE ===
total 48
drwxr-xr-x    8 root     root          4096 Jan 15 10:30 .
drwxr-xr-x    1 root     root          4096 Jan 15 10:30 ..
drwxr-xr-x    3 root     root          4096 Jan 15 10:30 apps
-rw-r--r--    1 root     root          1234 Jan 15 10:30 package.json
-rw-r--r--    1 root     root         56789 Jan 15 10:30 package-lock.json

=== APPS STRUCTURE ===
total 12
drwxr-xr-x    3 root     root          4096 Jan 15 10:30 .
drwxr-xr-x    3 root     root          4096 Jan 15 10:30 ..
drwxr-xr-x    8 root     root          4096 Jan 15 10:30 website

SERVER: [ 'entry.mjs', 'manifest_*.mjs', 'pages/', 'chunks/' ]
CLIENT: [ '_astro/', 'uploads/', 'cv_en/', 'cv_ru/', 'favorites/', ... ]
UPLOADS: [ 'about/', 'logos/', 'placeholders/', 'posts/' ]
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **Preprod —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ—á–Ω–æ –∫–∞–∫ local preview**  
‚úÖ **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**  
‚úÖ **Build args —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è –≤—Å–µ—Ö PUBLIC_* –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö**  
‚úÖ **–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∑–∞—â–∏—Ç—ã –æ—Ç –ø–æ–ª–æ–º–æ–∫**  
‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è debugging**  
‚úÖ **Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏**  

## üìÅ –§–∞–π–ª—ã –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞ VPS

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–∏ —Ñ–∞–π–ª—ã –Ω–∞ VPS:
- `apps/website/Dockerfile` ‚úÖ
- `package.json` ‚úÖ (–æ–±–Ω–æ–≤–ª–µ–Ω)
- `package-lock.json` ‚úÖ (—Å–æ–∑–¥–∞–Ω)
- `compose.prod.yml` ‚úÖ (–æ–±–Ω–æ–≤–ª–µ–Ω)
- `test-docker-build-vps.sh` ‚úÖ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

**–ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é!** üöÄ
